# Terraform Platform CI Infrastructure

A production-grade platform repository that bootstraps and manages **Terraform CI infrastructure** using **GitHub Actions** and **AWS remote state**.

This repository's only job is to provision the CI infrastructure that all Terraform runs depend on: a secure S3 state backend, a DynamoDB lock table, and an IAM role for GitHub Actions to assume via OIDC.

---

## Core Design

| Principle | Implementation |
|---|---|
| Git is the only source of truth | Every infra change starts as a commit |
| Terraform never runs locally | All `apply` runs happen in GitHub Actions |
| No long-lived credentials | GitHub Actions OIDC — credentials expire per job |
| State is remote, versioned, locked | S3 + DynamoDB |
| Runners are ephemeral | GitHub-hosted `ubuntu-latest` |
| Developers don't need AWS access | CI handles everything |
| Bootstrap is a one-time admin action | `install.sh` |

---

## Repository Structure

```
.
├── install.sh              # One-time bootstrap: provisions all CI infrastructure
├── uninstall.sh            # Teardown: destroys everything install.sh created
├── inventory.json          # Auto-generated by install.sh. Source of truth.
│
├── terraform/
│   ├── backend/
│   │   ├── main.tf         # S3 bucket + DynamoDB table
│   │   └── variables.tf
│   ├── iam/
│   │   ├── main.tf         # GitHub OIDC provider + IAM role
│   │   └── variables.tf
│   └── providers.tf        # Root module — add your application resources here
│
├── .github/
│   └── workflows/
│       └── terraform-apply.yaml   # CI pipeline — generated by install.sh
│
├── docs/
│   ├── architecture.md    # System design and component breakdown
│   ├── bootstrap.md       # Step-by-step install guide
│   ├── security.md        # IAM, OIDC, and threat model
│   └── operations.md      # Day-to-day operational reference
│
└── README.md
```

---

## Quick Start

### Prerequisites

- AWS administrator credentials (temporary — discarded after bootstrap)
- `aws` CLI v2, `terraform` ≥ 1.7, `git`, `jq`
- Repository cloned and pushed to GitHub with `origin` remote set

### Bootstrap (one-time, admin only)

```bash
bash install.sh
```

The script is interactive. It will:
1. Prompt for AWS region
2. Show you exactly what it will create
3. Ask for explicit confirmation
4. Provision S3, DynamoDB, and the IAM OIDC role via Terraform
5. Write `inventory.json`
6. Install the GitHub Actions workflow

Estimated time: 2–4 minutes.

### After Bootstrap

```bash
# Commit the generated files
git add inventory.json .github/workflows/terraform-apply.yaml
git commit -m "chore: bootstrap platform CI infrastructure"
git push origin main
```

GitHub Actions triggers automatically. From this point, every push to `main` runs Terraform in CI. No local Terraform, no local AWS credentials.

---

## How CI Works

```
git push → GitHub Actions → ubuntu-latest runner
                                    │
              OIDC token ───────────►│
                                    │
              AWS STS ◄─────────────│
              (temp credentials)    │
                                    │
                    terraform init  │  ← pulls state from S3
                    terraform plan  │  ← computes diff
                    terraform apply │  ← applies changes
                                    │
                          runner exits, credentials expire
```

The IAM role trust policy restricts OIDC token acceptance to your specific GitHub org, repo, and `main` branch. No other context can assume the role.

---

## Teardown

```bash
bash uninstall.sh
```

Reads `inventory.json`, displays a destruction plan, requires you to type `DESTROY`, then removes all platform infrastructure and cleans up local files.

---

## Documentation

| Doc | Contents |
|---|---|
| [Architecture](docs/architecture.md) | System diagram, component breakdown, state backend design |
| [Bootstrap](docs/bootstrap.md) | Prerequisites, installer walkthrough, troubleshooting |
| [Security](docs/security.md) | OIDC authentication flow, IAM trust policy, threat model |
| [Operations](docs/operations.md) | State lock management, state recovery, adding application infra |

---

## Cost

Monthly infrastructure cost is typically **under $1 USD**:

- S3 state storage: cents per month
- DynamoDB lock table: cents per month
- IAM + OIDC: free
- GitHub Actions runners: billed per execution minute

No idle infrastructure. All compute is ephemeral.

---

## What This Repository Is Not

This repository does **not** manage application infrastructure (EC2, RDS, ECS, etc.). It only provisions the CI plumbing that application infrastructure Terraform modules run through. Add your application modules to `terraform/providers.tf` and extend the IAM policy in `terraform/iam/main.tf`.
