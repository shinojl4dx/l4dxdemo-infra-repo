# =============================================================================
# .github/workflows/terraform-apply.yaml
#
# This file is generated by install.sh with real values substituted.
# This template version is committed to the repo for reference only.
#
# DO NOT edit the placeholder values manually — re-run install.sh instead.
# =============================================================================

name: Terraform Apply

on:
  push:
    branches:
      - main                        # Replaced by install.sh with actual default branch
    paths:
      - 'terraform/**/*.tf'         # Replaced by install.sh with actual watch directory
      - 'terraform/**/*.tfvars'     # Only triggers when .tf or .tfvars files change

permissions:
  id-token: write   # Required: lets GitHub issue an OIDC token
  contents: read    # Required: checkout access

jobs:
  terraform:
    name: Terraform Apply
    runs-on: ubuntu-latest
    environment: production

    env:
      AWS_REGION: us-east-1                          # Replaced by install.sh
      TF_BUCKET: tf-state-PLACEHOLDER                # Replaced by install.sh
      TF_LOCK_TABLE: tf-lock-PLACEHOLDER             # Replaced by install.sh

    steps:
      # ── 1. Checkout ──────────────────────────────────────────────────────────
      - name: Checkout
        uses: actions/checkout@v4

      # ── 2. Debug: show OIDC token claims (safe — no secrets exposed) ──────────
      # Remove this step once OIDC is confirmed working.
      - name: Debug OIDC token claims
        run: |
          TOKEN=$(curl -sSfL -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=sts.amazonaws.com" | jq -r '.value')
          echo "=== OIDC Token Claims ==="
          echo "$TOKEN" | cut -d. -f2 | base64 -d 2>/dev/null | jq .
          echo "sub claim (must match IAM trust policy):"
          echo "$TOKEN" | cut -d. -f2 | base64 -d 2>/dev/null | jq -r '.sub'

      # ── 3. AWS Auth via OIDC ─────────────────────────────────────────────────
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::ACCOUNT_ID:role/ROLE_NAME   # Replaced by install.sh
          aws-region: ${{ env.AWS_REGION }}

      # ── 3. Setup Terraform ───────────────────────────────────────────────────
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~> 1.7"

      # ── 4. Terraform Init ────────────────────────────────────────────────────
      - name: Terraform Init
        working-directory: terraform    # Replaced by install.sh with watch directory
        run: |
          terraform init \
            -backend-config="bucket=${{ env.TF_BUCKET }}" \
            -backend-config="key=platform/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ env.TF_LOCK_TABLE }}" \
            -backend-config="encrypt=true"

      # ── 5. Validate ──────────────────────────────────────────────────────────
      - name: Terraform Validate
        working-directory: terraform    # Replaced by install.sh
        run: terraform validate

      # ── 6. Plan ──────────────────────────────────────────────────────────────
      - name: Terraform Plan
        working-directory: terraform    # Replaced by install.sh
        run: terraform plan -out=tfplan

      # ── 7. Apply ─────────────────────────────────────────────────────────────
      - name: Terraform Apply
        working-directory: terraform    # Replaced by install.sh
        run: terraform apply -auto-approve tfplan
